name: WSA with GApps
on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture (arm64 or x64)'
        required: true
        default: 'arm64'
      android:
        description: 'Android version (13)'
        required: true
        default: '13'
      variant:
        description: 'gapps or nogapps'
        required: true
        default: 'gapps'
      root:
        description: 'none or magisk'
        required: true
        default: 'none'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full unzip lzip tar wget

      - name: Prepare folders
        run: |
          mkdir -p WSAGAScript/#IMAGES WSAGAScript/#GAPPS WSAGAScript/output

      - name: Download WSA msixbundle
        run: |
          wget -O WSAGAScript/#IMAGES/WSA.msixbundle \
            "https://store.rg-adguard.net/api/GetFiles?rid=9P3395VX91NR&ring=Retail&lang=en-US"

      - name: Download MindTheGapps
        run: |
          wget --content-disposition -O WSAGAScript/#GAPPS/mindthegapps.zip \
            "https://sourceforge.net/projects/eurekaroms/files/GApps/MindTheGapps/arm64/MindTheGapps-13.0.0-arm64-20231025_200931.zip/download"

      - name: Make scripts executable
        run: chmod +x WSAGAScript/*.sh

      - name: Extract GApps
        working-directory: WSAGAScript
        run: sudo bash extract_gapps_pico.sh

      - name: Extend and mount images
        working-directory: WSAGAScript
        run: sudo bash extend_and_mount_images.sh

      - name: Apply GApps
        working-directory: WSAGAScript
        run: sudo bash apply.sh

      - name: Unmount images
        working-directory: WSAGAScript
        run: sudo bash unmount_images.sh

      - name: Package results
        run: |
          7z a output/WSA-with-GApps-${{ github.run_id }}.7z WSAGAScript/*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: WSA-with-GApps
          path: output/*.7z
